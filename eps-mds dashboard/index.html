<head>
  <title>EPS - MDS</title>
  <script src="octokit-rest.js"></script>
  <script src="plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <link href="dashboard.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.5/dist/loadingoverlay.min.js"></script>

  <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->

</head>


<body>

  <nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="./">EPS-MDS</a>
    <input class="form-control form-control-dark w-100" type="text" placeholder="Search" aria-label="Search">
  </nav>

  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-2 d-none d-md-block bg-light sidebar">
        <div class="sidebar-sticky">
          <ul class="nav flex-column" id="repos"></ul>
        </div>
      </nav>

      <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Pairing Statistics</h1>
        </div>

        <div id="pairing" style="width:100%;height:80%;"></div>
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Issue Open Time</h1>
        </div>
        <div id="issues" style="width:100%;height:80%;"></div>
      </main>
    </div>
  </div>

  <!-- <div class="container-fluid">
    <div class="row">
      <div class="col-lg-2">
        <ul id="repos"></ul>
      </div>
      <div class="col-lg-10" id="pairing" style="width:90%;height:80%;"></div>
    </div>
  </div> -->

</body>

<script type="text/javascript">
  const octokit = new Octokit()
  $("#issues").LoadingOverlay("show", {
background: "rgba(255, 255, 255, 0)",
// image: "",
fontawesome: "fa fa-circle-notch fa-spin",
fontawesomeColor: "#565656"
});
  $("#pairing").LoadingOverlay("show", {
background: "rgba(255, 255, 255, 0)",
// image: "",
fontawesome: "fa fa-circle-notch fa-spin",
fontawesomeColor: "#565656"
});
  octokit.authenticate({
    type: 'oauth',
    token: '9324fedffc85017817ff2533e9237fc81fc611a9'
  })

  $("#repos").on("click", "li", function(e) {



getCommits("2018.2-" + $(this).text())
getIssues("2018.2-" + $(this).text())
  });

  async function paginateRepos(method) {
    let response = await method({
      org: "fga-eps-mds",
      per_page: 100
    })
    let {
      data
    } = response
    var count = 0;
    while (octokit.hasNextPage(response)) {
      count++;
      response = await octokit.getNextPage(response)
      data = data.concat(response.data)
    }
    return data
  }

  paginateRepos(octokit.repos.getForOrg)
    .then(data => {
      data.forEach(function(repo) {
        if (!repo.name.includes("2018.2")) {
          return;
        }
        var items = [];
        var itemId = repo.name.substring(7, repo.name.length);
        items.push('<li class="nav-item"><a class="nav-link" style="cursor: pointer;">' + itemId + '</a></li> ');
        $('#repos').append(items.join(''));
      })
    })

  function getCommits(repoName) {
    async function paginateCommits(method) {
      let response = await method({
        repo: repoName,
        owner: "fga-eps-mds"
      })
      let {
        data
      } = response
      var count = 0;
      while (octokit.hasNextPage(response)) {
        count++;
        response = await octokit.getNextPage(response)
        data = data.concat(response.data)
      }
      return data
    }

    paginateCommits(octokit.repos.getCommits).then(data => {
      calculatePair(data, repoName)
    })
  }

  function getIssues(repoName) {

    async function paginateIssues(method) {
      let response = await method({
        repo: repoName,
        owner: "fga-eps-mds",
        state: "all"
      })
      let {
        data
      } = response
      var count = 0;
      while (octokit.hasNextPage(response)) {
        count++;
        response = await octokit.getNextPage(response)
        data = data.concat(response.data)
      }
      return data
    }

    paginateIssues(octokit.issues.getForRepo).then(data => {
      calculateIssueTime(data, repoName)
    })

  }

  function calculateIssueTime(issues, repoName) {
    console.log(issues)
    all_issues = []
    days_open = {}
    issues.forEach(function(issue) {
      if (issue.pull_request == undefined) {
        let created_date = new Date(issue.created_at)
        created_date.setHours(created_date.getHours() - 3)

        if (issue.state == "closed") {
          let closed_date = new Date(issue.closed_at)
          closed_date.setHours(closed_date.getHours() - 3)
        } else {
          closed_date = new Date()
        }



        if (!days_open[Date.daysBetween(created_date, closed_date)])
          days_open[Date.daysBetween(created_date, closed_date)] = 0

        all_issues.push(issue)
        days_open[Date.daysBetween(created_date, closed_date)] += 1
      }

      drawBarPlot(days_open, repoName)

    })
  }

  function drawBarPlot(days_open, repoName) {
    ISSUES = document.getElementById('issues');
    Plotly.purge(ISSUES);

    var data = [
      {x: Object.keys(days_open),
      y: Object.values(days_open),
      type: 'bar'

    }
    ]

    title1 = "Active time of issues in project - " + repoName

    var layout = {
      title: title1,
      xaxis: {
        title: 'Days the issue was active'
      },
      yaxis: {
        title: 'Amount of issues'
      }
    }

    Plotly.plot(ISSUES, data, layout)
      $("#issues").LoadingOverlay("hide")

  }

  Date.daysBetween = function(date1, date2) {
    //Get 1 day in milliseconds
    var one_day = 1000 * 60 * 60 * 24;

    // Convert both dates to milliseconds
    var date1_ms = date1.getTime();
    var date2_ms = date2.getTime();

    // Calculate the difference in milliseconds
    var difference_ms = date2_ms - date1_ms;

    // Convert back to days and return
    return Math.round(difference_ms / one_day);
  }

  function occurrences(string, subString, allowOverlapping) {
    string += "";
    subString += "";
    if (subString.length <= 0) return (string.length + 1);

    var n = 0,
      pos = 0,
      step = allowOverlapping ? 1 : subString.length;

    while (true) {
      pos = string.indexOf(subString, pos);
      if (pos >= 0) {
        ++n;
        pos += step;
      } else break;
    }
    return n;

  }

  function clear_variables(commit_count, all_commit_count, signed_commit_count) {
    commit_count = []
    all_commit_count = {}
    signed_commit_count = {}
  }

  function calculatePair(commits, repoName) {
    let all_commit_count = {}
    let signed_commit_count = {}

    commits.forEach(function(commit) {
      date = new Date(commit.commit.author.date)
      date.setHours(date.getHours() - 3)
      var month = date.getUTCMonth() + 1;
      var day = date.getUTCDate();
      var year = date.getUTCFullYear();

      newdate = day + "/" + month + "/" + year;

      if (!all_commit_count[newdate])
        all_commit_count[newdate] = []
      if (!signed_commit_count[newdate])
        signed_commit_count[newdate] = 0
      all_commit_count[newdate].push(commit.commit)

      if (
        (occurrences(commit.commit.message, ("Co-authored-by:")) > 1) ||
        ((occurrences(commit.commit.message, ("Co-authored-by:")) == 1) && (commit.commit.message.indexOf(commit.commit.author.email))) ||
        (occurrences(commit.commit.message, ("Signed-off-by:")) > 1) ||
        ((occurrences(commit.commit.message, ("Signed-off-by:")) == 1) && (commit.commit.message.indexOf(commit.commit.author.email))) ||
        ((commit.commit.author.email != commit.commit.committer.email) && ("noreply@github.com" != commit.commit.committer.email))
      ) {

        signed_commit_count[newdate] += 1
      }
    })
    //
    let commit_count = []
    for (var key in all_commit_count) {
      commit_count.push(all_commit_count[key].length)
    }


    drawLinePlot(commit_count, all_commit_count, signed_commit_count, repoName)
    clear_variables(commit_count, all_commit_count, signed_commit_count)

  }



  function drawLinePlot(commit_count, all_commit_count, signed_commit_count, repoName) {
    TESTER = document.getElementById('pairing');
    Plotly.purge(TESTER);


    var trace0 = {
      x: Object.keys(all_commit_count).reverse(),
      y: commit_count.reverse(),
      name: 'All Commits'
    }
    var trace1 = {
      x: Object.keys(signed_commit_count).reverse(),
      y: Object.values(signed_commit_count).reverse(),
      name: "Signed-Off-By Commits"
    }
    var data = [trace0, trace1]
    title1 = "Pair programming evolution during project - " + repoName

    var layout = {
      title: title1,
      xaxis: {
        title: 'Date of commit'
      },
      yaxis: {
        title: 'Amount of commits'
      }
    }


    Plotly.plot(TESTER, data, layout)
      $("#pairing").LoadingOverlay("hide")
    clear_variables(commit_count, all_commit_count, signed_commit_count)



  }
</script>
